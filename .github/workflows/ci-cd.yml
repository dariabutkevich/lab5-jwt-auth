name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
    pull_request:
      branches: [ master ]
      types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  # =======================================================================
  # 1. –°–±–æ—Ä–∫–∞ –∏ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Æ–Ω–∏—Ç/–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (CI)
  # =======================================================================
  build_and_test:
    name: Build & Run Tests (CI)
    runs-on: ubuntu-latest
    
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
    env:
      DB_NAME: test_lab5db_test
      DB_USER: postgres
      DB_PASS: 12465067
      DB_HOST: localhost
      DB_PORT: 5432

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ PostgreSQL –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: ${{ env.DB_PASS }}
          POSTGRES_DB: ${{ env.DB_NAME }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        
      - name: ‚öôÔ∏è Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ‚è±Ô∏è Wait for PostgreSQL to be ready
        # –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ –ë–î —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞
        run: while ! pg_isready -h ${{ env.DB_HOST }} -p ${{ env.DB_PORT }}; do sleep 1; done
        
      - name: ‚¨áÔ∏è Install Dependencies
        run: npm ci

      - name: üß™ Run Tests (Unit & Integration)
        # –ó–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤ (auth.unit.test.js) –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (auth.test.js, server.test.js)
        run: npm test

      - name: üèóÔ∏è Build Static Files (npm run build)
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ index.html –∏ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è
        run: npm run build

      - name: ‚¨ÜÔ∏è Upload Build Artifact
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–ø–∞–ø–∫–∞ public/) –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: public/
          
  # =======================================================================
  # 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (Staging)
  # =======================================================================
  staging_deploy:
    name: Deploy to Staging
    needs: build_and_test # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥—É Staging (–Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ GitHub)
    environment: 
      name: Staging 
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ‚¨áÔ∏è Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact
          path: public/
          
      - name: üöÄ Deploy to GitHub Pages (Staging)
        id: deployment
        uses: actions/deploy-pages@v4 # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ GitHub Pages
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_directory: public
          
  # =======================================================================
  # 3. –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω (Production)
  # =======================================================================
  production_deploy:
    name: Deploy to Production
    needs: staging_deploy # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Staging
    # –£—Å–ª–æ–≤–∏–µ: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ job'—ã —É—Å–ø–µ—à–Ω—ã
    if: success() 
    runs-on: ubuntu-latest
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥—É Production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ)
    environment: 
      name: Production 
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: ‚¨áÔ∏è Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact
          path: public/
          
      - name: üöÄ Deploy to GitHub Pages (Production)
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_directory: public
# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ master ]
#   # –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow
#   workflow_dispatch:

# jobs:
#   # 1. –°–±–æ—Ä–∫–∞ –∏ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Æ–Ω–∏—Ç/–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (CI)
#   build_and_test:
#     name: Build & Run Tests (CI)
#     runs-on: ubuntu-latest
    
#     # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
#     env:
#       DB_NAME: test_lab5db_test
#       DB_USER: postgres
#       DB_PASS: 12465067
#       DB_HOST: localhost
#       DB_PORT: 5432

#     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ PostgreSQL –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
#     services:
#       postgres:
#         image: postgres:13
#         env:
#           POSTGRES_PASSWORD: ${{ env.DB_PASS }}
#           POSTGRES_DB: ${{ env.DB_NAME }}
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
          
#     steps:
#       - name: üì¶ Checkout Code
#         uses: actions/checkout@v4
        
#       - name: ‚öôÔ∏è Setup Node.js 20
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: ‚è±Ô∏è Wait for PostgreSQL to be ready
#         # –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ –ë–î —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞
#         run: while ! pg_isready -h ${{ env.DB_HOST }} -p ${{ env.DB_PORT }}; do sleep 1; done
        
#       - name: ‚¨áÔ∏è Install Dependencies
#         run: npm ci

#       - name: üß™ Run Tests (Unit & Integration)
#         # –ó–∞–ø—É—Å–∫ —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤ (auth.unit.test.js) –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (auth.test.js, server.test.js)
#         run: npm test

#       - name: üèóÔ∏è Build Static Files (npm run build)
#         # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ index.html –∏ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è
#         run: npm run build

#       - name: ‚¨ÜÔ∏è Upload Build Artifact
#         # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–ø–∞–ø–∫–∞ public/) –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
#         uses: actions/upload-artifact@v4
#         with:
#           name: deployment-artifact
#           path: public/
          
#   # 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (Staging)
#   staging_deploy:
#     name: Deploy to Staging
#     needs: build_and_test # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
#     runs-on: ubuntu-latest
    
#     # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥—É Staging (–Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ GitHub)
#     environment: 
#       name: Staging 
#       url: ${{ steps.deployment.outputs.page_url }}

#     steps:
#       - name: ‚¨áÔ∏è Download Artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: deployment-artifact
#           path: public/
          
#       - name: üöÄ Deploy to GitHub Pages (Staging)
#         id: deployment
#         uses: actions/deploy-pages@v4 # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ GitHub Pages
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           target_directory: public
          
#   # 3. –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω (Production)
#   production_deploy:
#     name: Deploy to Production
#     needs: staging_deploy # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Staging
#     # –£—Å–ª–æ–≤–∏–µ: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ job'—ã —É—Å–ø–µ—à–Ω—ã
#     if: success() 
#     runs-on: ubuntu-latest
    
#     # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥—É Production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ)
#     environment: 
#       name: Production 
#       url: ${{ steps.deployment.outputs.page_url }}
      
#     steps:
#       - name: ‚¨áÔ∏è Download Artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: deployment-artifact
#           path: public/
          
#       - name: üöÄ Deploy to GitHub Pages (Production)
#         id: deployment
#         uses: actions/deploy-pages@v4
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           target_directory: public