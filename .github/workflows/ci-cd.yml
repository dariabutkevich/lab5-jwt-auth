name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº workflow
  workflow_dispatch:

jobs:
  # 1. Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð®Ð½Ð¸Ñ‚/Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (CI)
  build_and_test:
    name: Build & Run Tests (CI)
    runs-on: ubuntu-latest
    
    # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ Ð‘Ð”
    env:
      DB_NAME: test_lab5db_test
      DB_USER: postgres
      DB_PASS: 12465067
      DB_HOST: localhost
      DB_PORT: 5432

    # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ° PostgreSQL Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: ${{ env.DB_PASS }}
          POSTGRES_DB: ${{ env.DB_NAME }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â±ï¸ Wait for PostgreSQL to be ready
        # ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼, Ð¿Ð¾ÐºÐ° Ð‘Ð” ÑÑ‚Ð°Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
        run: while ! pg_isready -h ${{ env.DB_HOST }} -p ${{ env.DB_PORT }}; do sleep 1; done
        
      - name: â¬‡ï¸ Install Dependencies
        run: npm ci

      - name: ðŸ§ª Run Tests (Unit & Integration)
        # Ð—Ð°Ð¿ÑƒÑÐº ÑŽÐ½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ð¾Ð² (auth.unit.test.js) Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² (auth.test.js, server.test.js)
        run: npm test

      - name: ðŸ—ï¸ Build Static Files (npm run build)
        # ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° index.html Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
        run: npm run build

      - name: â¬†ï¸ Upload Build Artifact
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð¿Ð°Ð¿ÐºÐ° public/) Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð°Ñ…
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: public/
  # 2. Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¼ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸ (Staging)
  staging_deploy:
    name: Deploy to Staging
    needs: build_and_test # Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
    runs-on: ubuntu-latest
    
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ€ÐµÐ´Ñƒ Staging (Ð½ÑƒÐ¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð² GitHub)
    environment: 
      name: Staging 
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: â¬‡ï¸ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact
          path: public/
          
      - name: ðŸš€ Deploy to GitHub Pages (Staging)
        id: deployment
        uses: actions/deploy-pages@v4 # Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° GitHub Pages
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_directory: public
          
  # 3. Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ (Production)
  production_deploy:
    name: Deploy to Production
    needs: staging_deploy # Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° Staging
    # Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ job'Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹
    if: success() 
    runs-on: ubuntu-latest
    
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ€ÐµÐ´Ñƒ Production (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ðµ Ð¾Ð´Ð¾Ð±Ñ€ÐµÐ½Ð¸Ðµ)
    environment: 
      name: Production 
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: â¬‡ï¸ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifact
          path: public/
          
      - name: ðŸš€ Deploy to GitHub Pages (Production)
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_directory: public
# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ master ]
# jobs:
#   lint:
#     runs-on: ubuntu-latest
#     services:
#       postgres:
#         image: postgres:13
#         env:
#           POSTGRES_PASSWORD: 12465067
#           POSTGRES_DB: test_lab5db_test
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5
#     steps:
#       - name:  Checkout
#         uses: actions/checkout@v4
#       - name: Install deps
#         run: npm ci
#       - name: Lint
#         run: npm run lint
# jobs:
#   test:
#     runs-on: ubuntu-latest
#     services:
#       postgres:
#         image: postgres:13
#         env:
#           POSTGRES_PASSWORD: 12465067
#           POSTGRES_DB: test_lab5db_test
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd pg_isready
#           --health-interval 10s
#           --health-timeout 5s
#           --health-retries 5

#     steps:
#     - uses: actions/checkout@v4

#     - name: Use Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies
#       run: npm ci

#     - name: Run unit tests
#       run: npm run test:unit
#       env:
#         NODE_ENV: test

#     - name: Run integration tests
#       run: npm run test:integration
#       env:
#         NODE_ENV: test
#         DB_HOST: localhost
#         DB_PORT: 5432
#         DB_USER: postgres
#         DB_PASSWORD: 12465067
#         DB_NAME: test_lab5db_test

#   deploy-staging:
#     needs: test
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
#     steps:
#     - uses: actions/checkout@v4

#     - name: Deploy to Render Staging
#       run: |
#         curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID_STAGING }}/deploys \
#           -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
#           -d '{"branch": "main"}'
#       env:
#         NODE_ENV: staging

#   deploy-prod:
#     needs: deploy-staging
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4

#     - name: Deploy to Render Prod
#       run: |
#         curl -X POST https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID_PROD }}/deploys \
#           -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
#           -d '{"branch": "main"}'
#       env:
#         NODE_ENV: production

#   monitor:
#     needs: deploy-prod
#     runs-on: ubuntu-latest
#     steps:
#     # - name: Health Check
#     #   run: curl -f https://your-app-staging.onrender.com/ || exit 1 
#     - name: Monitor
#       run: echo "Check Render dashboard: errors=0, load<50%"